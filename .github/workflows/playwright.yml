name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    # 1. Ejecuci√≥n de los tests
    - name: Run Playwright tests
      run: npx playwright test --project=chromium --project=firefox --project=webkit

    # 2. Generar Reporte Ejecutivo de QA
    - name: Generar Resumen QA
      if: always()
      run: |
        # Extracci√≥n de m√©tricas clave desde el XML
        TOTAL=$(grep -oP 'tests="\K[^"]+' results.xml | head -1)
        FALLOS=$(grep -oP 'failures="\K[^"]+' results.xml | head -1)
        ERRORES=$(grep -oP 'errors="\K[^"]+' results.xml | head -1)
        SALTADOS=$(grep -oP 'skipped="\K[^"]+' results.xml | head -1)
        TIEMPO=$(grep -oP 'time="\K[^"]+' results.xml | head -1)
        FECHA=$(date +'%d/%m/%Y %H:%M')

        # Formateo del mensaje con cabeceras y detalles
        echo "===================================================="
        echo "üìä INFORME DE CALIDAD (QA)"
        echo "===================================================="
        echo "üìÖ Fecha de Ejecuci√≥n : $FECHA"
        echo "‚è±Ô∏è Tiempo Total        : ${TIEMPO} segundos"
        echo "----------------------------------------------------"
        echo "üìà M√âTRICAS DE PRUEBAS:"
        echo "  ‚úÖ Pruebas Totales  : $TOTAL"
        echo "  ‚ùå Pruebas Fallidas : $FALLOS"
        echo "  ‚ö†Ô∏è Errores T√©cnicos : $ERRORES"
        echo "  ‚è≠Ô∏è Pruebas Saltadas : $SALTADOS"
        echo "----------------------------------------------------"
        echo "üîó Estado Final: $( [ "$FALLOS" -eq 0 ] && echo "PASS ‚úÖ" || echo "FAIL ‚ùå" )"
        echo "===================================================="
        # --------------------------

    # 3. Recolecci√≥n de evidencias para reportes y Excel
    - name: Subir reportes y resultados para Excel
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }} # Se ejecuta siempre, incluso si hay fallos, para no perder la evidencia
      with:
        name: reporte-completo-qa # Nombre del archivo .zip
        path: |
          playwright-report/
          results.xml
        # results.xml es el archivo Excel de informe
        retention-days: 30 # Tiempo que GitHub guardar√° estos archivos
